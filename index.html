<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Secret Meet - Premium Chat</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://sad.adsgram.ai/js/sad.min.js"></script>
    <script src='//libtl.com/sdk.js' data-zone='9341070' data-sdk='show_9341070'></script>
    
    <style>
        :root {
            --primary: #ff0080;
            --secondary: #7928ca;
            --bg-dark: #0a0b1e;
            --glass: rgba(255, 255, 255, 0.1);
            --text-main: #ffffff;
            --text-muted: #a0a0b8;
        }

        body { 
            background: radial-gradient(circle at top right, #1a1b3a, #0a0b1e); 
            color: var(--text-main); 
            font-family: 'Inter', -apple-system, sans-serif; 
            margin: 0; padding: 0;
            overflow: hidden; 
            height: 100vh;
            width: 100%;
        }

        #app { display: flex; flex-direction: column; height: 100vh; }

        /* Header */
        .header { 
            background: rgba(15, 12, 41, 0.8);
            backdrop-filter: blur(15px);
            padding: 15px; text-align: center; 
            font-size: 1.1rem; font-weight: 800; 
            border-bottom: 1px solid rgba(255, 0, 128, 0.3);
            flex-shrink: 0;
        }

        /* Home Screen */
        #home-screen { 
            flex: 1; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; padding: 30px;
            animation: fadeIn 0.8s ease;
        }

        /* Chat Screen */
        #chat-screen { flex: 1; display: none; flex-direction: column; overflow: hidden; }
        
        #messages { 
            flex: 1; overflow-y: auto; padding: 15px; 
            display: flex; flex-direction: column; gap: 12px;
            -webkit-overflow-scrolling: touch;
        }

        /* Message Bubbles */
        .msg { 
            padding: 12px 18px; border-radius: 18px; max-width: 85%; 
            font-size: 15px; line-height: 1.4; word-wrap: break-word;
            animation: slideUp 0.3s ease;
        }
        .me { background: linear-gradient(135deg, var(--primary), var(--secondary)); align-self: flex-end; border-bottom-right-radius: 4px; }
        .partner { background: var(--glass); backdrop-filter: blur(10px); align-self: flex-start; border-bottom-left-radius: 4px; }

        /* Input Area */
        .input-area { 
            padding: 10px 15px; background: rgba(10, 11, 30, 0.95);
            display: flex; gap: 10px; border-top: 1px solid rgba(255,255,255,0.1);
            padding-bottom: env(safe-area-inset-bottom, 10px);
        }

        input { 
            flex: 1; padding: 12px 20px; border-radius: 25px; 
            border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); 
            color: white; outline: none; font-size: 16px; 
        }

        .send-btn, .photo-btn { 
            width: 45px; height: 45px; border-radius: 50%; border: none;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .send-btn { background: var(--primary); color: white; }
        .photo-btn { background: var(--glass); color: white; font-size: 20px; }

        /* Searching Animation */
        .searching-wrapper { position: relative; display: none; width: 120px; height: 120px; margin-bottom: 20px; }
        .searching-wrapper .circle { position: absolute; width: 100%; height: 100%; border-radius: 50%; background: var(--primary); opacity: 0; animation: pulse 2s infinite linear; }
        .searching-wrapper .circle:nth-child(2) { animation-delay: 0.6s; }
        .searching-wrapper .circle:nth-child(3) { animation-delay: 1.2s; }
        .searching-icon { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 50px; }

        @keyframes pulse { 0% { transform: scale(0.5); opacity: 0; } 50% { opacity: 0.3; } 100% { transform: scale(2); opacity: 0; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .chat-img { width: 100%; max-width: 220px; border-radius: 12px; display: block; margin-top: 5px; }
        .status-msg { font-size: 12px; color: var(--text-muted); text-align: center; margin: 10px 0; }
        
        /* Modal Style */
        #limit-modal { 
            display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
            background:rgba(0,0,0,0.9); backdrop-filter:blur(10px); z-index:9999; 
            align-items:center; justify-content:center; 
        }
        .modal-content {
            background: #1a1b3a; border: 1px solid var(--primary); padding:30px; 
            border-radius:25px; width:85%; max-width:320px; text-align:center;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="header">MatchMe üíå</div>
        
        <div id="home-screen">
            <div id="search-anim" class="searching-wrapper">
                <div class="circle"></div><div class="circle"></div><div class="circle"></div>
                <div class="searching-icon">üîç</div>
            </div>
            <div id="main-emoji" style="font-size: 60px; margin-bottom: 20px;">üé≠</div>
            <h1>Ready to Mingle?</h1>
            <p style="color: var(--text-muted);">Connect anonymously with random people.</p>
            <button id="findBtn" onclick="handleFind()" style="padding: 16px 50px; border-radius: 30px; border: none; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; font-size: 17px; font-weight: 700; cursor: pointer; margin-top: 20px;">üîç Start Searching</button>
            <a href="https://t.me/MakefriendsglobalBot?start=7837044057" style="margin-top:25px; color:var(--primary); text-decoration:none; font-size:14px;">ü§ñ Open Bot for Rewards</a>
        </div>

        <div id="chat-screen">
            <div id="messages"></div>
            <div class="input-area">
                <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="sendPhoto(this)">
                <button class="photo-btn" onclick="document.getElementById('fileInput').click()">üñºÔ∏è</button>
                <input id="minput" type="text" placeholder="Write a message...">
                <button class="send-btn" onclick="sendMsg()">‚û§</button>
            </div>
            <button onclick="endChatLocal()" style="background:transparent; border:none; color:red; padding:10px; font-size:11px; font-weight:bold; letter-spacing:1px;">STOP CONVERSATION</button>
        </div>
    </div>

    <div id="limit-modal">
        <div class="modal-content">
            <div style="font-size:45px;">üíé</div>
            <h2 style="color:var(--primary); margin: 10px 0;">Limit Reached!</h2>
            <p style="color:var(--text-muted); font-size:14px; margin-bottom:20px;">Watch a short video to get <b>+5 bonus matches</b> instantly!</p>
            <button id="rewardBtn" onclick="watchRewardAd()" style="background:#00ffcc; color:#000; border:none; padding:14px; border-radius:15px; font-weight:800; width:100%; cursor:pointer;">üì∫ Watch Video (+5)</button>
            <button onclick="location.reload()" style="background:transparent; color:white; border:none; margin-top:15px; opacity:0.6;">Cancel</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const socket = io();
        const userId = tg.initDataUnsafe?.user?.id;

        // --- Ad Initialization ---
        const AdsgramInterstitial = window.Adsgram.init({ blockId: "int-11153" });
        const AdsgramRewarded = window.Adsgram.init({ blockId: "YOUR_REWARDED_BLOCK_ID" }); // Replace this!

        tg.expand();
        if (userId) socket.emit('join', userId);

        // Monetag In-App Setup
        if(window.show_9341070) {
            show_9341070({
                type: 'inApp',
                inAppSettings: { frequency: 2, capping: 0.1, interval: 60, timeout: 30 }
            });
        }

        // --- Core Functions ---
        function handleFind() {
            AdsgramInterstitial.show()
                .then(() => startSearching())
                .catch(() => startSearching()); 
        }

        function startSearching() {
            document.getElementById('main-emoji').style.display = 'none';
            document.getElementById('search-anim').style.display = 'block';
            document.getElementById('findBtn').disabled = true;
            document.getElementById('findBtn').style.opacity = "0.5";
            socket.emit('find_partner_web', userId);
        }

        function watchRewardAd() {
            const btn = document.getElementById('rewardBtn');
            btn.innerText = "‚è≥ Loading Video...";
            btn.disabled = true;

            AdsgramRewarded.show().then((result) => {
                if (result.done) {
                    socket.emit('reward_user', userId);
                    tg.HapticFeedback.notificationOccurred('success');
                    btn.innerText = "‚úÖ Matches Added!";
                    setTimeout(() => location.reload(), 1500);
                } else {
                    btn.innerText = "üì∫ Watch Video (+5)";
                    btn.disabled = false;
                }
            }).catch(() => {
                alert("Ad failed to load. Try again later.");
                btn.innerText = "üì∫ Watch Video (+5)";
                btn.disabled = false;
            });
        }

        // --- Socket Events ---
        socket.on('match_found', () => {
            tg.HapticFeedback.notificationOccurred('success');
            document.getElementById('home-screen').style.display = 'none';
            document.getElementById('chat-screen').style.display = 'flex';
            addStatusMessage("‚ú® You are now connected! Say hello.");
        });

        socket.on('receive_msg', (data) => {
            tg.HapticFeedback.impactOccurred('light');
            if (data.image) addImageMessage(data.image, 'partner');
            else if (data.text) addMessage(data.text, 'partner');
        });

        socket.on('chat_ended', () => {
            addStatusMessage("üö´ Partner left the chat.");
            setTimeout(() => location.reload(), 2500);
        });

        socket.on('limit_over', () => {
            document.getElementById('limit-modal').style.display = 'flex';
        });

        // --- Messaging Functions ---
        function sendMsg() {
            const inp = document.getElementById('minput');
            if (!inp.value.trim()) return;
            addMessage(inp.value, 'me');
            socket.emit('send_msg', { senderId: userId, text: inp.value });
            inp.value = '';
        }

        function sendPhoto(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const imgData = e.target.result;
                    addImageMessage(imgData, 'me');
                    socket.emit('send_msg', { senderId: userId, image: imgData });
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function addMessage(text, type) {
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.innerText = text;
            appendAndScroll(div);
        }

        function addImageMessage(src, type) {
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.innerHTML = `<img src="${src}" class="chat-img">`;
            appendAndScroll(div);
        }

        function addStatusMessage(text) {
            const p = document.createElement('p');
            p.className = 'status-msg';
            p.innerText = text;
            appendAndScroll(p);
        }

        function appendAndScroll(el) {
            const box = document.getElementById('messages');
            box.appendChild(el);
            box.scrollTop = box.scrollHeight;
        }

        function endChatLocal() {
            socket.emit('leave_chat', userId);
            location.reload();
        }
    </script>
</body>
</html>
